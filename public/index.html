<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Result Portal</title>
    
    <link rel="icon" href="data:,">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@0.263.1"></script>

    <style>
        @media print {
            .no-print { display: none !important; }
            .print-border { border: 2px solid black !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // --- CRITICAL CONFIGURATION ---
        // Use relative path so it works on BOTH Localhost and Vercel automatically
        const API_URL = "/api"; 

        // --- SAFE ICON COMPONENT (Prevents Black Screen Crashes) ---
        const Icon = ({ name, size = 20 }) => {
            // 1. Check if library loaded
            if (!window.lucide || !window.lucide.icons) {
                return <span className="text-xs text-gray-400">Loading...</span>;
            }
            // 2. Check if specific icon exists
            const iconNode = window.lucide.icons[name];
            if (!iconNode) {
                console.warn(`Icon not found: ${name}`);
                return <span className="text-xs text-red-500">?</span>;
            }
            
            // 3. Render safely
            const svg = iconNode.toSvg({ width: size, height: size });
            return <span className="inline-flex mr-2 align-middle" dangerouslySetInnerHTML={{ __html: svg }} />;
        };

        // --- 1. LOGIN COMPONENT ---
        const Login = ({ onLogin }) => {
            const [role, setRole] = useState('student');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [msg, setMsg] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setMsg('');
                setLoading(true);
                try {
                    const res = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    
                    if (res.ok) {
                        if (data.role !== role) { 
                            setMsg(`Access Denied: You are trying to login as ${role} but this account is ${data.role}`); 
                        } else {
                            onLogin(data);
                        }
                    } else {
                        setMsg(data.message || "Invalid Credentials");
                    }
                } catch (err) { 
                    console.error("Login Error:", err);
                    setMsg("Server Connection Failed. Check Console."); 
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <div className="flex bg-gray-100 p-1 rounded mb-6">
                            <button onClick={() => setRole('student')} className={`flex-1 py-2 font-bold text-sm rounded transition ${role === 'student' ? 'bg-white shadow text-blue-700' : 'text-gray-400'}`}>Student</button>
                            <button onClick={() => setRole('admin')} className={`flex-1 py-2 font-bold text-sm rounded transition ${role === 'admin' ? 'bg-white shadow text-blue-700' : 'text-gray-400'}`}>Admin</button>
                        </div>
                        <h2 className="text-2xl font-bold text-center mb-2">University Portal</h2>
                        <p className="text-center text-gray-400 text-sm mb-6">{role === 'student' ? 'Enter ID & DOB' : 'Admin Credentials'}</p>
                        
                        {msg && <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm border border-red-200">{msg}</div>}
                        
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input className="w-full border p-3 rounded" placeholder={role === 'student' ? "Student ID" : "Username"} value={username} onChange={e=>setUsername(e.target.value)} required />
                            <input type={role === 'student' ? "text" : "password"} className="w-full border p-3 rounded" placeholder={role === 'student' ? "DOB (YYYY-MM-DD)" : "Password"} value={password} onChange={e=>setPassword(e.target.value)} required />
                            <button disabled={loading} className="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded transition">
                                {loading ? "Verifying..." : "Login"}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- 2. ADMIN DASHBOARD ---
        const AdminDashboard = ({ user, onLogout }) => {
            const [status, setStatus] = useState('');
            const [deleteSem, setDeleteSem] = useState('');

            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                
                reader.onload = async (ev) => {
                    const lines = ev.target.result.split('\n');
                    const groupedData = {};

                    // Group rows by "StudentID + Semester"
                    for (let i = 1; i < lines.length; i++) {
                        const row = lines[i].split(',');
                        if (row.length < 9) continue;
                        const [id, name, dob, sem, gpa, sub, code, grd, crd] = row.map(x => x.trim());

                        const key = `${id}-${sem}`;

                        if (!groupedData[key]) {
                            groupedData[key] = {
                                studentId: id,
                                studentName: name,
                                dob: dob,
                                semester: sem,
                                gpa: Number(gpa),
                                subjects: [] 
                            };
                        }
                        
                        groupedData[key].subjects.push({
                            name: sub,
                            code: code,
                            grade: grd,
                            credits: Number(crd)
                        });
                    }

                    const payload = Object.values(groupedData);

                    try {
                        setStatus(`Uploading ${payload.length} semester records...`);
                        const res = await fetch(`${API_URL}/results/bulk`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const d = await res.json();
                        setStatus(res.ok ? `‚úÖ ${d.message}` : '‚ùå Failed: ' + (d.message || "Unknown error"));
                    } catch (err) { setStatus('‚ùå Server Error'); }
                };
                reader.readAsText(file);
            };

            const handleDelete = async () => {
                if(!deleteSem) return;
                if(!confirm(`Delete all results for "${deleteSem}"?`)) return;
                try {
                    const res = await fetch(`${API_URL}/results/delete-semester`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ semester: deleteSem })
                    });
                    const d = await res.json();
                    setStatus(`üóëÔ∏è ${d.message}`);
                } catch(err) { setStatus("‚ùå Delete Failed"); }
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-10">
                    <div className="flex justify-between items-center mb-10">
                        <h1 className="text-2xl font-bold flex items-center"><Icon name="Shield"/> Admin Console</h1>
                        <button onClick={onLogout} className="bg-slate-200 px-4 py-2 rounded text-sm font-bold">Logout</button>
                    </div>
                    
                    <div className="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                        {/* UPLOAD SECTION */}
                        <div className="bg-white p-8 rounded-xl shadow-lg text-center border border-slate-200">
                            <div className="mb-4 inline-block p-4 bg-blue-50 rounded-full text-blue-600"><Icon name="UploadCloud" size={40}/></div>
                            <h2 className="text-xl font-bold mb-2">Upload Results</h2>
                            <p className="text-sm text-gray-500 mb-4">Select your CSV file to auto-create students and upload grades.</p>
                            <div className="relative group cursor-pointer border-2 border-dashed border-slate-300 rounded-xl p-6 bg-slate-50 hover:bg-blue-50 transition">
                                <input type="file" accept=".csv" onChange={handleUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                <p className="font-bold text-slate-600 group-hover:text-blue-600">Click to Select CSV</p>
                            </div>
                        </div>

                        {/* DELETE SECTION */}
                        <div className="bg-white p-8 rounded-xl shadow-lg text-center border border-slate-200">
                            <div className="mb-4 inline-block p-4 bg-red-50 rounded-full text-red-600"><Icon name="Trash2" size={40}/></div>
                            <h2 className="text-xl font-bold mb-2">Clean Up Data</h2>
                            <p className="text-sm text-gray-500 mb-4">Remove all results for a specific semester.</p>
                            <div className="flex gap-2">
                                <input className="border p-2 rounded w-full" placeholder='e.g. "Fall 2024"' value={deleteSem} onChange={e=>setDeleteSem(e.target.value)} />
                                <button onClick={handleDelete} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Delete</button>
                            </div>
                        </div>
                    </div>

                    {status && <div className="mt-8 p-4 bg-slate-800 text-white rounded font-bold text-center max-w-xl mx-auto shadow-lg">{status}</div>}
                </div>
            );
        };

        // --- 3. STUDENT DASHBOARD ---
        const StudentDashboard = ({ user, onLogout }) => {
            const [allResults, setAllResults] = useState([]);
            const [selectedSem, setSelectedSem] = useState(null);

            useEffect(() => {
                fetch(`${API_URL}/results/${user.id}`)
                    .then(r => r.json())
                    .then(data => {
                        setAllResults(data);
                        if(data.length > 0) setSelectedSem(data[0]);
                    })
                    .catch(err => console.error("Fetch Error:", err));
            }, [user.id]);

            return (
                <div className="min-h-screen bg-gray-200 p-4 md:p-8">
                    <div className="no-print flex justify-between items-center mb-6 bg-white p-4 rounded-lg shadow">
                        <h1 className="text-xl font-bold text-blue-800 flex items-center"><Icon name="GraduationCap"/> Student Portal</h1>
                        <button onClick={onLogout} className="text-sm bg-red-50 text-red-600 px-3 py-1 rounded hover:bg-red-100 transition">Logout</button>
                    </div>

                    {allResults.length === 0 ? <div className="text-center text-gray-500 mt-20">No records found.</div> : (
                        <div className="max-w-4xl mx-auto">
                            <div className="no-print mb-6 flex items-center gap-4 bg-white p-4 rounded-lg shadow-sm">
                                <label className="font-bold text-gray-600">Select Semester:</label>
                                <select className="border p-2 rounded w-64 outline-none font-bold" onChange={(e) => setSelectedSem(allResults[e.target.value])}>
                                    {allResults.map((sem, index) => <option key={index} value={index}>{sem.semester}</option>)}
                                </select>
                                <button onClick={() => window.print()} className="ml-auto bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-700"><Icon name="Printer" size={16}/> Print</button>
                            </div>

                            {selectedSem && (
                                <div className="bg-white p-10 shadow-2xl print-border min-h-[800px] relative">
                                    <div className="text-center border-b-2 border-gray-900 pb-4 mb-8">
                                        <h1 className="text-3xl font-serif font-bold text-gray-900 uppercase">Institute of Technology</h1>
                                        <p className="text-gray-500 font-serif text-sm tracking-widest mt-1">OFFICIAL GRADE CARD</p>
                                    </div>
                                    <div className="flex justify-between mb-8 font-serif text-sm">
                                        <div>
                                            <p className="mb-1"><span className="font-bold w-24 inline-block">Name:</span> {user.name}</p>
                                            <p className="mb-1"><span className="font-bold w-24 inline-block">Reg No:</span> {user.id}</p>
                                            <p className="mb-1"><span className="font-bold w-24 inline-block">Program:</span> B.Tech</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="mb-1"><span className="font-bold">Semester:</span> <span className="uppercase">{selectedSem.semester}</span></p>
                                            <p className="mb-1"><span className="font-bold">Date:</span> {new Date().toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <table className="w-full border-collapse border border-gray-900 font-serif text-sm mb-8">
                                        <thead className="bg-gray-100">
                                            <tr>
                                                <th className="border border-gray-600 p-2 w-20 text-center">Code</th>
                                                <th className="border border-gray-600 p-2 text-left">Course Title</th>
                                                <th className="border border-gray-600 p-2 w-16 text-center">Credits</th>
                                                <th className="border border-gray-600 p-2 w-16 text-center">Grade</th>
                                                <th className="border border-gray-600 p-2 w-24 text-center">Result</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {selectedSem.subjects.map((sub, i) => (
                                                <tr key={i}>
                                                    <td className="border border-gray-600 p-2 text-center">{sub.code}</td>
                                                    <td className="border border-gray-600 p-2 font-bold">{sub.name}</td>
                                                    <td className="border border-gray-600 p-2 text-center">{sub.credits}</td>
                                                    <td className="border border-gray-600 p-2 text-center font-bold">{sub.grade}</td>
                                                    <td className="border border-gray-600 p-2 text-center uppercase text-xs">{['F','Ab'].includes(sub.grade) ? 'Fail' : 'Pass'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <div className="flex justify-end">
                                        <div className="border border-gray-900 p-2 px-6 bg-gray-50 text-center">
                                            <span className="block text-xs uppercase font-bold text-gray-500">SGPA</span>
                                            <span className="text-2xl font-bold font-serif">{selectedSem.gpa}</span>
                                        </div>
                                    </div>
                                    <div className="absolute bottom-10 left-10 right-10 flex justify-between border-t border-gray-300 pt-4 font-serif text-xs text-gray-500">
                                        <p>This is a computer generated document.</p>
                                        <p className="font-bold text-black">Controller of Examinations</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            
            // ERROR BOUNDARY (Prevent White Screen Crash)
            try {
                if (!user) return <Login onLogin={setUser} />;
                return user.role === 'admin' 
                    ? <AdminDashboard user={user} onLogout={()=>setUser(null)}/> 
                    : <StudentDashboard user={user} onLogout={()=>setUser(null)}/>;
            } catch (err) {
                return <div className="text-red-600 p-10 text-center">Application Error: {err.message}</div>;
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>